<!doctype html>
<html lang="en">
    <head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="https://bootswatch.com/4/darkly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin="anonymous" />
	<style>
            html, body, .container, .page { height: 100% }
	    body { text-align: center; }
	    h1 {
	        text-align: center;
		padding-top: 1em;
		margin-bottom: 1em;
                font-size: 5em;
	    }
            button[name=submit] { margin-top: 2em; }
            .page { height: 100% }
            input[type=number] {
                text-align: center;
                font-size: 2em;
                font-family: monospace;
            }
	</style>
    </head>
    <body>
	<div class="container">
	<div class="page row" id="auth-code">
	    <div class="col-12">
                <h1><i class="fas fa-user-secret"></i></h1>
		<form>
		    <div class="form-row">
			<div class="col-12">
			    <label>Enter your access code</label>
			    <input name="code" type="number" autocomplete="off" class="form-control">
			    <div class="invalid-feedback">
				Code invalid, did you enter it correctly?
			    </div>
			</div>
		    </div>
		    <button type="submit" class="btn btn-primary" name="submit">Authenticate</button><br>
		</form>
	    </div>
	</div>
	<div class="page row" id="lobby">
	    <h1><i class="fas fa-compass fa-spin"></i></h1>
	    <p>Please await further instructions...<p>
            <p><span>0</span> people joined the game</p>
	</div>
	<div class="page row" id="countdown">
            <h1><i class="fas fa-exclamation-triangle"></i></h1>
	    <p>Round 1 starting in...<p>
            <h1 class="count">5</h1>
	</div>
	<div class="page row" id="count-code">
            <div class="col-12">
                <h1><i class="fas fa-users"></i></h1>
		<form>
		    <div class="form-row">
			<div class="col-12">
			    <label>How many people have the same screen color?</label>
			    <input name="code" type="number" autocomplete="off" class="form-control">
			    <div class="invalid-feedback">
				Incorrect, please try again!
			    </div>
			</div>
		    </div>
		    <button type="submit" class="btn btn-primary" name="submit">Submit</button><br>
		</form>
	    </div>
	</div>
	<div class="page row" id="wait-for-groups">
            <h1><i class="fas fa-thumbs-up"></i></h1>
            <h1><span class="done">5</span> / <span class="total">5</span></h1>
	    <p>Waiting for other teams to finish...<p>
	</div>
	<div class="page row" id="success">
	    <h1><i class="fas fa-check"></i></h1>
            <h1>Succes!</h1>
	    <p>Round 1 completed, get ready for round 2...<p>
	</div>
	</div>
	<script type="text/javascript">
	    (function() {
                var $ = document.querySelector.bind(document);
                var $$ = document.querySelectorAll.bind(document);

                function showPage(page) {
                    var pages = $$(".page");
		    for (var i = 0; i < pages.length; i++) {
			pages[i].style.display = "none";
		    }
		    $("#" + page).style.display = "block";
		};

                function send(ws, data) {
                    ws.send(JSON.stringify(data));
                };

		showPage("auth-code");

	    	var ws = new WebSocket("ws://localhost:8000");

                $("#auth-code form").onsubmit = function() {
                    send(ws, {
                        "type": "auth-code",
                        "code": parseInt($("#auth-code input[name=code]").value),
                    });
		    return false;
		};

                $("#count-code form").onsubmit = function() {
                    send(ws, {
                        "type": "count-code",
                        "code": parseInt($("#count-code input[name=code]").value),
                    });
		    return false;
		};

		ws.onmessage = function(event) {
                    console.log(event)
		    var data = JSON.parse(event.data);
		    console.log(data);
		    var type = data["type"];

		    if (type == "auth-code-ok") {
			$("#count-code").style.background = data["color_1"];
			showPage("lobby");
		    }
		    else if (type == "auth-code-invalid") {
			$("#auth-code .invalid-feedback").style.display = "block";
			showPage("auth-code");
                    }
                    else if (type == "lobby-count") {
                        $("#lobby p span").innerText = data["count"];
                    }
		    else if (type == "countdown") {
			var count = data["count"];
			showPage("countdown");
			$("#countdown .count").innerText = count;
                        window.navigator.vibrate(200);
		    }
		    else if (type == "show-count-code") {
			showPage("count-code");
                    }
                    else if (type == "count-code-ok") {
                        console.warn("COUNT CODE OK, DONE");
		    }
		    else if (type == "count-code-invalid") {
			$("#count-code .invalid-feedback").style.display = "block";
			showPage("count-code");
                    }
                    else if (type == "wait-for-groups") {
                        $("#wait-for-groups .total").innerText = data["total"];
                        $("#wait-for-groups .done").innerText = data["done"];
                        showPage("wait-for-groups");
                    }
                    else if (type == "show-success") {
                        showPage("success");
                    }
                    else if (type == "reset") {
                        window.location = "";
                    }
		};
            })()
	</script>
    </body>
</html>
